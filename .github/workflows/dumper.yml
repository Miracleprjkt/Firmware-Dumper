name: Firmware Dump

on:
  workflow_dispatch:
    inputs:
      FIRMWARE_LINK:
        description: 'Firmware Link'
        required: true
        default: ''

jobs:
  build:
    name: Dump by ${{ github.actor }}
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id
    permissions:
      contents: write
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Cleanup
      uses: rokibhasansagar/slimhub_actions@main
      
    - name: Set Swap Space
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 12
        
    - name: Setup Dump Environment
      run: |
        mkdir -p workspace && cd workspace
        git clone https://github.com/neilchetty/Dumper-Scripts dumper --depth=1
        cd dumper && bash setup.sh

    - name: Dump Firmware
      run: |
        cd workspace/dumper
        bash dumper.sh ${{ github.event.inputs.FIRMWARE_LINK }}
    
    - name: Set Variables
      run: |
        cd workspace/dumper/out
        rm -rf .git
        echo "VENDOR_NAME=$(cat README.md | cut -d "-" -f 2 | grep -w "Codename" | head -n 1 | cut -d ":" -f 2 | cut -d " " -f 2)" >> $GITHUB_ENV
        echo "MANUFACTURER_NAME=$(cat README.md | cut -d "-" -f 2 | grep -w "Manufacturer" | head -n 1 | cut -d ":" -f 2 | cut -d " " -f 2)" >> $GITHUB_ENV
        echo "BRANCH=$(cat README.md | cut -d "-" -f 2 | grep -w "Id" | head -n 1 | cut -d ":" -f 2 | cut -d " " -f 2)" >> $GITHUB_ENV
        
    - name: Create Gitlab Repository
      run: |
        cd workspace
        curl --header "PRIVATE-TOKEN: ${{ secrets.GITLAB_TOKEN }}" -X POST "https://gitlab.com/api/v4/projects?name=android_dump_${{ env.MANUFACTURER_NAME }}_${{ env.VENDOR_NAME }}&visibility=public" > repo.json
        echo "USERNAME=$(cat repo.json | grep -o '"username":"[^"]*' | cut -d'"' -f4)" >> $GITHUB_ENV

    - name: Push as Repository
      run: |
        cd workspace/dumper/out
        rm -rf .git
        DUMP_DIR_LIST=$(find -type d -printf "%P\n" | grep -v / | grep -v .git)
        git init
        find . -size +97M -printf '%P\n' -o -name "*sensetime*" -printf '%P\n' -o -name "*.lic" -printf '%P\n' >| .gitignore
        git branch -M ${{ env.BRANCH }}
        git config --global user.name "Miracleprjkt"
        git config --global user.email "fathiralmsyah3@gmail.com"
        git remote add origin https://${{ secrets.GITLAB_TOKEN_NAME }}:${{ secrets.GITLAB_TOKEN }}@gitlab.com/${{ env.USERNAME }}/android_dump_${{ env.MANUFACTURER_NAME }}_${{ env.VENDOR_NAME }}.git
        for dir in ${DUMP_DIR_LIST}; do
            git add ${dir}
            git commit -s -m "dump: ${dir}: import dump for ${VENDOR_NAME}
            Firmware: ${{ github.event.inputs.FIRMWARE_LINK }}"
            git push -u origin ${{ env.BRANCH }}
        done
        git add .
        git commit -s -m "dump: import remaining dump for ${VENDOR_NAME}
        Firmware: ${{ github.event.inputs.FIRMWARE_LINK }}"
        git push -u origin ${{ env.BRANCH }}
